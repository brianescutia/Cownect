<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Career Discovery - UC Davis Tech Quiz</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="/styles/navbar.css" />
    <link rel="stylesheet" href="../styles/enhanced-quiz.css" />
    <link rel="stylesheet" href="../styles/dark.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Navbar Scripts -->
    <script src="/scripts/navbar-component.js" defer></script>
    <script src="/scripts/navbar.js" defer></script>
    <script src="/scripts/enhancedThreeLevelQuizData.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'davis-blue': '#022851',
                        'davis-gold': '#FFBF00',
                        'tech-purple': '#6366f1',
                        'tech-cyan': '#06b6d4'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'bounce-in': 'bounceIn 0.6s ease-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navbar - Will be dynamically loaded -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Introduction Screen -->
        <div id="introScreen" class="space-y-8 animate-fade-in">
            <!-- Hero Section -->
            <div class="text-center gradient-bg rounded-2xl p-8 text-white">
                <div class="animate-bounce-in">
                    <h2 class="text-4xl font-bold mb-4">üöÄ Enhanced 3-Level Career Discovery</h2>
                    <p class="text-xl text-blue-100 mb-6 max-w-2xl mx-auto">
                        Revolutionary AI-powered assessment with level-based progression. 
                        Get career guidance that matches your experience and provides targeted next steps.
                    </p>
                    <div class="glass-effect rounded-lg p-4 max-w-md mx-auto">
                        <div class="text-2xl font-bold">Choose Your Level</div>
                        <div class="text-blue-200">Beginner ‚Ä¢ Intermediate ‚Ä¢ Advanced</div>
                    </div>
                </div>
            </div>

            <!-- What Makes It Special -->
            <div class="bg-white rounded-xl p-8 shadow-lg">
                <h3 class="text-2xl font-bold text-center mb-6 text-gray-900">üåü Enhanced Features</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg">
                        <div class="text-3xl mb-3">üéØ</div>
                        <h4 class="font-bold text-gray-900 mb-2">Level-Based Progression</h4>
                        <p class="text-sm text-gray-600">Questions and guidance tailored to your experience level</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-cyan-50 to-teal-50 rounded-lg">
                        <div class="text-3xl mb-3">üé®</div>
                        <h4 class="font-bold text-gray-900 mb-2">Varied Question Types</h4>
                        <p class="text-sm text-gray-600">Scenarios, scales, visuals, and rankings prevent boredom</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg">
                        <div class="text-3xl mb-3">üß†</div>
                        <h4 class="font-bold text-gray-900 mb-2">Enhanced AI Analysis</h4>
                        <p class="text-sm text-gray-600">Experience-specific insights and development recommendations</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-red-50 rounded-lg">
                        <div class="text-3xl mb-3">üéì</div>
                        <h4 class="font-bold text-gray-900 mb-2">UC Davis Integration</h4>
                        <p class="text-sm text-gray-600">Level-appropriate courses, clubs, and campus resources</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-pink-50 to-purple-50 rounded-lg">
                        <div class="text-3xl mb-3">üõ°Ô∏è</div>
                        <h4 class="font-bold text-gray-900 mb-2">Gaming-Resistant</h4>
                        <p class="text-sm text-gray-600">Multiple formats make manipulation nearly impossible</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg">
                        <div class="text-3xl mb-3">‚ö°</div>
                        <h4 class="font-bold text-gray-900 mb-2">Instant Results</h4>
                        <p class="text-sm text-gray-600">Get comprehensive insights and action plans immediately</p>
                    </div>
                </div>
            </div>

            <!-- Start Button -->
            <div class="text-center">
                <button id="startQuizBtn" class="bg-gradient-to-r from-tech-purple to-tech-cyan text-white px-8 py-4 rounded-xl text-lg font-bold hover:shadow-xl transition-all duration-300 hover:scale-105 animate-pulse-glow">
                    üöÄ Choose Your Experience Level
                </button>
                <p class="text-sm text-gray-600 mt-4">Trusted by UC Davis students ‚Ä¢ Enhanced with GPT-4</p>
            </div>
        </div>

        <!-- Level Selection Screen -->
        <div id="levelSelection" class="hidden space-y-8 animate-fade-in">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Choose Your Experience Level</h2>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                    Select the level that best matches your current tech experience for the most accurate career guidance.
                </p>
            </div>

            <div class="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                <!-- Beginner Level -->
                <div class="level-card cursor-pointer transform hover:scale-105 transition-all duration-300" data-level="beginner">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-200 hover:border-green-400">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 text-center">
                            <div class="text-4xl mb-3"></div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Tech Explorer</h3>
                            <p class="text-green-600 font-medium">New to tech? Discover your path.</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Duration:</span>
                                    <span class="font-semibold">5-7 minutes</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">12 questions</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Perfect for students exploring tech careers with no prior experience.</p>
                            <div class="text-xs text-gray-500 mb-4">
                            </div>
                            <button class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                Start Exploring
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Intermediate Level -->
                <div class="level-card cursor-pointer transform hover:scale-105 transition-all duration-300" data-level="intermediate">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-200 hover:border-blue-400">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 text-center">
                            <div class="text-4xl mb-3"></div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Tech Curious</h3>
                            <p class="text-blue-600 font-medium">Some experience? Find your specialization.</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Duration:</span>
                                    <span class="font-semibold">8-10 minutes</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">10 questions</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                   
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">For students with some coding classes or tech exposure seeking their ideal focus.</p>
                            <div class="text-xs text-gray-500 mb-4">
                            </div>
                            <button class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                                Find My Specialization
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Level -->
                <div class="level-card cursor-pointer transform hover:scale-105 transition-all duration-300" data-level="advanced">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-200 hover:border-purple-400">
                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 p-6 text-center">
                            <div class="text-4xl mb-3"></div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Tech Insider</h3>
                            <p class="text-purple-600 font-medium">Experienced? Optimize your trajectory.</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Duration:</span>
                                    <span class="font-semibold">10-12 minutes</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-semibold">10 questions</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">For experienced students with internships and leadership roles seeking their ideal path.</p>
                            <div class="text-xs text-gray-500 mb-4">
                                
                            </div>
                            <button class="w-full bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                                Optimize My Path
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center">
                <button id="backToIntroBtn" class="text-gray-600 hover:text-gray-800 flex items-center mx-auto transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    </svg>
                </button>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="quizInterface" class="hidden">
            <!-- Progress Bar -->
            <div class="bg-white rounded-xl p-6 mb-6 shadow-lg sticky top-20 z-40">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="quizTitle" class="text-xl font-bold text-gray-900">Enhanced Career Assessment</h2>
                    <div class="flex items-center space-x-4">
                        <span id="selectedLevel" class="text-sm bg-gray-100 px-3 py-1 rounded-full"></span>
                        <span id="progressText" class="text-sm text-gray-600"></span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="bg-gradient-to-r from-tech-purple to-tech-cyan h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Question Container -->
            <div id="questionContainer" class="question-card bg-white rounded-xl p-8 shadow-lg animate-slide-up">
                <!-- Question content will be populated by JavaScript -->
            </div>

            <!-- Navigation -->
            <div class="flex justify-between items-center mt-8">
                <button id="prevButton" class="px-6 py-3 text-gray-600 hover:text-gray-800 flex items-center transition-colors" style="display: none;">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                
                <button id="nextButton" class="px-8 py-3 bg-gradient-to-r from-tech-purple to-tech-cyan text-white rounded-lg hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center transition-all" disabled>
                    <span id="nextButtonText">Continue</span>
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="hidden text-center py-12">
            <div class="bg-white rounded-xl p-8 shadow-lg max-w-md mx-auto">
                <div class="animate-spin w-16 h-16 border-4 border-tech-purple border-t-transparent rounded-full mx-auto mb-6"></div>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">ü§ñ Enhanced AI Analysis</h3>
                <p class="text-gray-600 mb-4">Our advanced AI is analyzing your responses with level-specific insights...</p>
                <div class="text-sm text-tech-purple font-medium">
                    <span id="loadingStep" class="typing-indicator">Processing your responses...</span>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden space-y-6">
            <!-- Results will be populated by JavaScript -->
        </div>
    </main>

    <!-- Profile Script -->
    <script src="/scripts/navbar-profile.js" defer></script>

    <!-- JavaScript -->
    <script>
        class EnhancedThreeLevelQuizApp {
            constructor() {
                this.selectedLevel = null;
                this.questions = [];
                this.answers = [];
                this.currentQuestionIndex = 0;
                this.startTime = null;
                this.isSubmitting = false; // Add this line
                this.init();
            }

            async init() {
                console.log('üöÄ Initializing Enhanced 3-Level Career Quiz...');
                this.setupEventListeners();
                this.showLevelSelection(); // Skip intro and go directly to level selection
            }

            setupEventListeners() {
                document.getElementById('startQuizBtn').addEventListener('click', () => this.showLevelSelection());
                document.getElementById('backToIntroBtn').addEventListener('click', () => this.showScreen('introScreen'));
                
                // Level selection handlers
                document.querySelectorAll('.level-card').forEach(card => {
                    card.addEventListener('click', () => this.selectLevel(card.dataset.level));
                });

                // Navigation buttons
                document.getElementById('prevButton').addEventListener('click', () => this.previousQuestion());
                document.getElementById('nextButton').addEventListener('click', () => this.nextQuestion());
            }

            showLevelSelection() {
                this.showScreen('levelSelection');
            }

            async selectLevel(level) {
                console.log(`üéØ Level selected: ${level}`);
                this.selectedLevel = level;
                
                // Visual feedback
                document.querySelectorAll('.level-card').forEach(card => {
                    card.style.opacity = card.dataset.level === level ? '1' : '0.5';
                });

                // Load questions for the selected level
                await this.loadQuestionsForLevel(level);
                
                setTimeout(() => this.startQuiz(), 500);
            }

            async loadQuestionsForLevel(level) {
    try {
        console.log(`Loading ${level} level questions...`);
        
        // Try to fetch from server first
        try {
            const response = await fetch(`/api/quiz/enhanced/questions/${level}`);
            if (response.ok) {
                const data = await response.json();
                this.questions = data.questions;
                console.log(`Loaded ${this.questions.length} ${level} questions from server`);
                return;
            }
        } catch (serverError) {
            console.warn('Server not available, using local question data');
        }
        
        // Fallback to local question data from enhancedthreelevelquizdata.js
        if (typeof window.enhancedQuizQuestions !== 'undefined') {
            this.questions = window.enhancedQuizQuestions[level] || window.enhancedThreeLevelQuizQuestions.beginner;
            console.log(`Loaded ${this.questions.length} ${level} questions from local data`);
        } else {
            throw new Error('Question data not available');
        }
        
    } catch (error) {
        console.error('Error loading questions:', error);
        alert('Failed to load quiz questions. Please refresh the page.');
    }
}
                    
            startQuiz() {
    console.log(`Starting ${this.selectedLevel} level quiz...`);
    this.startTime = Date.now();
    this.currentQuestionIndex = 0;
    this.answers = new Array(this.questions.length).fill(null);
    
    // Debug logging
    console.log('Total questions loaded:', this.questions.length);
    console.log('Question IDs:', this.questions.map(q => q.id));
    console.log('Answers array initialized:', this.answers.length);
    
    // Update UI with level info
    document.getElementById('selectedLevel').textContent = this.selectedLevel.charAt(0).toUpperCase() + this.selectedLevel.slice(1);
    
    this.showScreen('quizInterface');
    this.renderQuestion();
}

            renderQuestion() {
    const question = this.questions[this.currentQuestionIndex];
    
    if (!question) {
        console.error('No question found at index:', this.currentQuestionIndex);
        return;
    }
    
    console.log('Rendering question type:', question.type, question);
    
    // Update progress
    document.getElementById('progressText').textContent = `Question ${this.currentQuestionIndex + 1} of ${this.questions.length}`;
    const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;

    const container = document.getElementById('questionContainer');
    
    // Handle different question types based on your data structure
    switch (question.type) {
        case 'short_response':
            this.renderShortResponse(question, container);
            break;
        case 'multiple_choice':
        case 'scenario':
            this.renderMultipleChoice(question, container);
            break;
        case 'visual_choice':
            this.renderVisualChoice(question, container);
            break;
        case 'scale':
            this.renderScale(question, container);
            break;
        case 'ranking':
            this.renderRanking(question, container);
            break;
        default:
            console.error('Unknown question type:', question.type);
    }

    this.updateNavigation();
    setTimeout(() => this.restorePreviousAnswer(), 100);

}

restorePreviousAnswer() {
    const savedAnswer = this.answers[this.currentQuestionIndex];
    if (!savedAnswer) return;
    
    const question = this.questions[this.currentQuestionIndex];
    
    switch (question.type) {
        case 'short_response':
            const textArea = document.getElementById('textResponse');
            if (textArea && savedAnswer.textResponse) {
                textArea.value = savedAnswer.textResponse;
                this.updateTextResponse(savedAnswer.textResponse);
            }
            break;
            
        case 'visual_choice':
        case 'multiple_choice':
        case 'scenario':
            if (savedAnswer.selectedOption) {
                const optionEl = document.querySelector(`[data-option-id="${savedAnswer.selectedOption.id}"]`);
                if (optionEl) {
                    optionEl.classList.add('selected');
                    optionEl.style.borderColor = '#6366f1';
                }
            }
            break;
            
        case 'scale':
            if (savedAnswer.scaleValue) {
                const slider = document.getElementById('scaleSlider');
                if (slider) {
                    slider.value = savedAnswer.scaleValue;
                    this.updateScale(savedAnswer.scaleValue);
                }
            }
            break;
    }
}

renderShortResponse(question, container) {
    container.innerHTML = `
        <div class="mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">${question.question}</h3>
            ${question.subtitle ? `<p class="text-gray-600 mb-4">${question.subtitle}</p>` : ''}
        </div>
        
        <div class="max-w-2xl mx-auto">
            <textarea id="textResponse" 
                      class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-tech-purple focus:outline-none transition-colors" 
                      rows="4"
                      placeholder="${question.placeholder || 'Share your thoughts...'}"
                      maxlength="${question.max_length || 500}"
                      oninput="enhancedQuizApp.updateTextResponse(this.value)"></textarea>
            <div class="flex justify-between text-sm text-gray-500 mt-2">
                <span>Share your authentic experience</span>
                <span id="charCount">0/${question.max_length || 500}</span>
            </div>
        </div>
    `;
}

renderMultipleChoice(question, container) {
    container.innerHTML = `
        <div class="mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">${question.question}</h3>
            ${question.subtitle ? `<p class="text-gray-600 mb-4">${question.subtitle}</p>` : ''}
        </div>
        
        <div class="space-y-4">
            ${question.options.map(option => `
                <div class="option-card p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-tech-purple transition-all" 
                     data-option-id="${option.id}"
                     onclick="enhancedQuizApp.selectOption('${option.id}')">
                    <h4 class="text-lg font-bold text-gray-900 mb-2">${option.title}</h4>
                    <p class="text-gray-600">${option.description}</p>
                </div>
            `).join('')}
        </div>
    `;
}

renderVisualChoice(question, container) {
    container.innerHTML = `
        <div class="text-center mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">${question.question}</h3>
            <p class="text-gray-600">${question.subtitle || ''}</p>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6">
            ${question.options.map(option => `
                <div class="visual-option p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-tech-purple transition-all" 
                     data-option-id="${option.id}">
                    <div class="text-center">
                        <div class="text-4xl mb-4">${option.visual || 'üéØ'}</div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">${option.title}</h4>
                        <p class="text-gray-600 text-sm">${option.description}</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Add click handlers after rendering
    container.querySelectorAll('.visual-option').forEach(optionEl => {
        optionEl.addEventListener('click', () => {
            // Clear all selections first
            container.querySelectorAll('.visual-option').forEach(el => {
                el.classList.remove('selected');
                el.style.borderColor = '#e5e7eb';
            });
            
            // Select this option
            optionEl.classList.add('selected');
            optionEl.style.borderColor = '#6366f1';
            
            const optionId = optionEl.dataset.optionId;
            const selectedOption = question.options.find(opt => opt.id === optionId);
            this.saveResponse({ selectedOption });
        });
    });
}

renderScale(question, container) {
    // Find a valid starting value that exists in the labels
    const validValues = Object.keys(question.scale.labels).map(Number);
    const middleValue = validValues[Math.floor(validValues.length / 2)];
    
    container.innerHTML = `
        <div class="text-center mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">${question.question}</h3>
            <p class="text-gray-600">${question.subtitle || ''}</p>
        </div>
        
        <div class="max-w-2xl mx-auto">
            <div class="mb-6">
                <input type="range" id="scaleSlider" class="scale-slider w-full" 
                       min="${question.scale.min}" max="${question.scale.max}" value="${middleValue}"
                       oninput="enhancedQuizApp.updateScale(this.value)">
            </div>
            
            <div class="text-center mb-6">
                <div id="scaleValue" class="text-2xl font-bold text-tech-purple mb-2">${middleValue}</div>
                <div id="scaleLabel" class="text-lg font-medium text-gray-900 mb-2">${question.scale.labels[middleValue]}</div>
                <div id="scaleDescription" class="text-gray-600">${question.scale.descriptions[middleValue]}</div>
            </div>
            
            <div class="flex justify-between text-sm text-gray-500">
                <span>${question.scale.labels[question.scale.min]}</span>
                <span>${question.scale.labels[question.scale.max]}</span>
            </div>
        </div>
    `;
    
    // Auto-save the default value
    this.saveResponse({ scaleValue: middleValue });
}

renderRanking(question, container) {
    container.innerHTML = `
        <div class="mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">${question.question}</h3>
            <p class="text-gray-600">${question.subtitle}</p>
        </div>
        
        <div class="max-w-2xl mx-auto">
            <p class="text-sm text-gray-600 mb-6 text-center">Drag items to reorder them from most important (top) to least important (bottom)</p>
            
            <div id="rankingContainer" class="space-y-3">
                ${question.items.map((item, index) => `
                    <div class="drag-item p-4 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-grab" 
                         draggable="true"
                         data-item-id="${item.id}"
                         data-item-index="${index}">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-tech-purple text-white rounded-full flex items-center justify-center mr-4 font-bold rank-number">
                                ${index + 1}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900">${item.text}</h4>
                                <p class="text-sm text-gray-600">${item.description}</p>
                            </div>
                            <div class="text-gray-400 ml-2">‚ãÆ‚ãÆ</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Initialize drag and drop functionality
    this.initializeDragAndDrop();
    
    // Save initial ranking
    const ranking = question.items.map(item => item.id);
    this.saveResponse({ ranking });
}

initializeDragAndDrop() {
    const container = document.getElementById('rankingContainer');
    let draggedElement = null;
    
    // Add event listeners to all drag items
    const dragItems = container.querySelectorAll('.drag-item');
    
    dragItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedElement = item;
            item.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', (e) => {
            item.style.opacity = '1';
            draggedElement = null;
            this.updateRankNumbers();
            this.saveRankingOrder();
        });
        
        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        item.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedElement && draggedElement !== item) {
                const container = item.parentNode;
                const draggedRect = draggedElement.getBoundingClientRect();
                const targetRect = item.getBoundingClientRect();
                
                if (draggedRect.top < targetRect.top) {
                    container.insertBefore(draggedElement, item.nextSibling);
                } else {
                    container.insertBefore(draggedElement, item);
                }
            }
        });
    });
}

updateRankNumbers() {
    const items = document.querySelectorAll('#rankingContainer .drag-item');
    items.forEach((item, index) => {
        const rankNumber = item.querySelector('.rank-number');
        rankNumber.textContent = index + 1;
    });
}

saveRankingOrder() {
    const items = document.querySelectorAll('#rankingContainer .drag-item');
    const ranking = Array.from(items).map(item => item.dataset.itemId);
    this.saveResponse({ ranking });
}

updateScale(value) {
    const question = this.questions[this.currentQuestionIndex];
    const intValue = parseInt(value);
    
    document.getElementById('scaleValue').textContent = intValue;
    
    // Use fallback text if label/description doesn't exist for this value
    const label = question.scale.labels[intValue] || `Level ${intValue}`;
    const description = question.scale.descriptions[intValue] || `Selected value: ${intValue}`;
    
    document.getElementById('scaleLabel').textContent = label;
    document.getElementById('scaleDescription').textContent = description;
    
    this.saveResponse({ scaleValue: intValue });
}
updateTextResponse(value) {
    const question = this.questions[this.currentQuestionIndex];
    document.getElementById('charCount').textContent = `${value.length}/${question.max_length || 500}`;
    this.saveResponse({ textResponse: value });
}

            selectOption(optionId) {
                // Clear previous selections
                document.querySelectorAll('.option-card').forEach(el => {
                    el.classList.remove('selected');
                    el.style.borderColor = '#e5e7eb';
                });

                // Select new option
                const selectedEl = document.querySelector(`[data-option-id="${optionId}"]`);
                selectedEl.classList.add('selected');
                selectedEl.style.borderColor = '#6366f1';

                // Find the selected option data
                const question = this.questions[this.currentQuestionIndex];
                const selectedOption = question.options.find(opt => opt.id === optionId);

                this.saveResponse({ selectedOption: selectedOption });
            }

            saveResponse(responseData) {
    console.log('Saving response for question index:', this.currentQuestionIndex);
    console.log('Question ID:', this.questions[this.currentQuestionIndex]?.id);
    
    this.answers[this.currentQuestionIndex] = {
        questionId: this.questions[this.currentQuestionIndex].id,
        questionType: this.questions[this.currentQuestionIndex].type,
        ...responseData,
        timestamp: new Date().toISOString(),
        timeTaken: Date.now() - this.startTime
    };
    
    console.log('Response saved:', this.answers[this.currentQuestionIndex]);
    console.log('Answers collected so far:', this.answers.filter(a => a !== null).length);
    
    // Enable next button
    document.getElementById('nextButton').disabled = false;
}
            updateNavigation() {
                const prevBtn = document.getElementById('prevButton');
                const nextBtn = document.getElementById('nextButton');
                const nextBtnText = document.getElementById('nextButtonText');

                prevBtn.style.display = this.currentQuestionIndex === 0 ? 'none' : 'flex';
                nextBtn.disabled = !this.answers[this.currentQuestionIndex];

                if (this.currentQuestionIndex === this.questions.length - 1) {
                    nextBtnText.textContent = 'Get My Enhanced Analysis';
                } else {
                    nextBtnText.textContent = 'Continue';
                }
            }

            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.renderQuestion();
                }
            }

            nextQuestion() {
    if (this.isSubmitting) return; // Prevent multiple submissions
    
    console.log('Next question called. Current index:', this.currentQuestionIndex, 'Total questions:', this.questions.length);
    
    if (this.currentQuestionIndex < this.questions.length - 1) {
        this.currentQuestionIndex++;
        this.renderQuestion();
    } else {
        console.log('Reached end of quiz. Submitting...');
        if (!this.isSubmitting) {
            this.isSubmitting = true;
            document.getElementById('nextButton').disabled = true; // Disable button
            this.submitQuiz();
        }
    }
}

            async submitQuiz() {
    console.log(`Submitting ${this.selectedLevel} level quiz for enhanced AI analysis...`);
    
    this.showScreen('loadingScreen');
    this.animateLoadingSteps();
    
    try {
        const submissionData = {
            level: this.selectedLevel,
            answers: this.answers.filter(a => a !== null),
            completionTime: Math.floor((Date.now() - this.startTime) / 1000),
            metadata: {
                version: '3.0-Enhanced',
                timestamp: new Date().toISOString()
            }
        };

        console.log('Submitting to server:', submissionData);
        console.log('Number of answers:', submissionData.answers.length);

        const response = await fetch('/api/quiz/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(submissionData)
        });

        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        if (!response.ok) {
            const errorText = await response.text();
            console.log('Error response:', errorText);
            throw new Error(`Server error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('Received results from server:', data);
        
        this.displayResults(data.results || data);
        
    } catch (error) {
        console.error('Quiz submission error details:', error);
        console.error('Error message:', error.message);
        this.showScreen('levelSelection');
        alert('Failed to analyze your responses. Please try again.');
    }
}


            animateLoadingSteps() {
                const steps = [
                    'Analyzing psychological patterns...',
                    'Detecting authentic preferences...',
                    'Matching with career profiles...',
                    'Generating personalized insights...',
                    'Preparing your custom action plan...'
                ];
                
                let stepIndex = 0;
                const stepElement = document.getElementById('loadingStep');
                
                const updateStep = () => {
                    if (stepIndex < steps.length) {
                        stepElement.textContent = steps[stepIndex];
                        stepIndex++;
                        setTimeout(updateStep, 800);
                    }
                };
                
                updateStep();
            }

            displayResults(results) {
    this.showScreen('resultsScreen');
    
    const container = document.getElementById('resultsScreen');
    
    // Handle the results structure from your backend
    const topMatch = results.topMatch || results.results?.topMatch;
    const allMatches = results.allMatches || results.results?.allMatches || [];
    
    if (!topMatch) {
        console.error('No top match found in results:', results);
        return;
    }
    
    container.innerHTML = `
        <div class="gradient-bg text-white rounded-xl p-8 text-center animate-bounce-in">
            <h2 class="text-3xl font-bold mb-4">Your Enhanced ${this.selectedLevel.charAt(0).toUpperCase() + this.selectedLevel.slice(1)} Analysis is Ready!</h2>
            <div class="glass-effect rounded-lg p-6 max-w-2xl mx-auto">
                <h3 class="text-2xl font-bold mb-2">${topMatch.career}</h3>
                <div class="text-4xl font-bold mb-2">${topMatch.percentage}% Match</div>
                <p class="text-blue-100">${topMatch.reasoning || 'AI-powered career analysis based on your responses.'}</p>
            </div>
        </div>
        
        <div class="bg-white rounded-xl p-8 shadow-lg">
            <h3 class="text-xl font-bold mb-4">AI Career Analysis Results</h3>
            <div class="space-y-4">
                <p><strong>Career:</strong> ${topMatch.career}</p>
                <p><strong>Match Percentage:</strong> ${topMatch.percentage}%</p>
                <p><strong>Reasoning:</strong> ${topMatch.reasoning || 'Based on your responses and preferences.'}</p>
            </div>
        </div>
        
        <div class="text-center space-y-4">
            <button onclick="enhancedQuizApp.retakeQuiz()" class="bg-gradient-to-r from-tech-purple to-tech-cyan text-white px-8 py-3 rounded-xl font-bold hover:shadow-lg transition-all mr-4">
                Try Another Level
            </button>
            <button onclick="window.location.href='/tech-clubs'" class="bg-white text-tech-purple border-2 border-tech-purple px-8 py-3 rounded-xl font-bold hover:bg-tech-purple hover:text-white transition-all">
                Explore UC Davis Clubs
            </button>
        </div>
    `;
}

            showScreen(screenId) {
                const screens = ['introScreen', 'levelSelection', 'quizInterface', 'loadingScreen', 'resultsScreen'];
                screens.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.toggle('hidden', id !== screenId);
                    }
                });
            }

            retakeQuiz() {
                this.selectedLevel = null;
                this.currentQuestionIndex = 0;
                this.answers = [];
                this.startTime = null;
                this.questions = [];
                
                // Reset level card styles
                document.querySelectorAll('.level-card').forEach(card => {
                    card.style.opacity = '1';
                });
                
                this.showScreen('levelSelection');
            }
        }

        // Initialize the app
        let enhancedQuizApp;
        document.addEventListener('DOMContentLoaded', () => {
            enhancedQuizApp = new EnhancedThreeLevelQuizApp();
            console.log('Enhanced 3-Level Career Quiz loaded successfully');
        });

        // Make it globally accessible
        window.enhancedQuizApp = enhancedQuizApp;

    </script>
</body>
</html>