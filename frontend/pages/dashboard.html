<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Cownect</title>
  <link rel="stylesheet" href="/styles/fonts.css" />
  <link rel="stylesheet" href="/styles/navbar.css" />
  <link rel="stylesheet" href="/styles/dashboard.css" />
  <link rel="stylesheet" href="/styles/footer.css" />

  
  <!-- Scripts -->
  <script src="/scripts/dashboard.js" defer></script>
 <script src="/scripts/navbar-component.js?v=3" defer></script>
<script src="/scripts/navbar.js?v=3" defer></script>
<script>src ="/scripts/matching-system.js" </script>
<script src="/scripts/footer.js" defer></script>

</head>

<body>
  <!-- Background blur decorations -->
  <div class="blur-decoration-left"></div>
  <div class="blur-decoration-right"></div>

  <!-- Navbar with enhanced profile circle -->


  <!-- Logout Button -->
  <div class="logout-button-container">
    <button class="logout-btn" onclick="logoutUser()" title="Logout">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16,17 21,12 16,7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      Logout
    </button>
  </div>

  <!-- Dashboard Container -->
  <main class="dashboard-container">
    
    <!-- Enhanced User Profile Card -->
    <section class="user-profile-card">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-image-container">
          <div class="profile-image" id="profileImage" onclick="document.getElementById('imageUpload').click()">
            <img id="profileImageDisplay" src="" alt="Profile" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            <span id="profileInitials">JD</span>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <div class="image-upload-overlay">
              <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.1 3.89 23 5 23H19C20.1 23 21 22.1 21 21V9M19 9H14V4H19V9Z"/>
              </svg>
            </div>
          </div>
        </div>
        <div class="profile-basic-info">
          <div class="user-display-name" id="userDisplayName">UC Davis Student</div>
          <div class="user-email" id="userEmail">student@ucdavis.edu</div>
          <div class="profile-completion">
            <div class="completion-bar">
              <div class="completion-fill" id="completionFill" style="width: 0%"></div>
            </div>
            <span class="completion-text" id="completionText">0% Complete</span>
          </div>
        </div>
      </div>

      <!-- Enhanced Profile Form -->
      <div class="profile-form" id="profileForm">
        
        <!-- Basic Information -->
        <div class="form-section">
          <h4>Basic Information</h4>
          
          <div class="form-row">
            <label for="profileName">Full Name *</label>
            <input type="text" id="profileName" placeholder="Your full name" maxlength="100">
          </div>

          <div class="form-row-group">
            <div class="form-row">
              <label for="profileYear">Year *</label>
              <select id="profileYear">
                <option value="">Select year</option>
                <option value="freshman">Freshman</option>
                <option value="sophomore">Sophomore</option>
                <option value="junior">Junior</option>
                <option value="senior">Senior</option>
                <option value="graduate">Graduate</option>
                <option value="phd">PhD</option>
                <option value="postdoc">Postdoc</option>
              </select>
            </div>

            <div class="form-row">
              <label for="profileMajor">Major *</label>
              <input type="text" id="profileMajor" placeholder="Computer Science" maxlength="100">
            </div>
          </div>

          <div class="form-row">
            <label for="profileBio">Bio *</label>
            <textarea id="profileBio" placeholder="Tell others about yourself..." maxlength="500" rows="3"></textarea>
          </div>

          <div class="form-row">
            <label for="profileHobbies">Interests & Hobbies</label>
            <input type="text" id="profileHobbies" placeholder="coding, music, hiking, photography" maxlength="300">
            <small>Separate with commas</small>
          </div>
        </div>

        <!-- Networking & Matching -->
        <div class="form-section">
          <h4>Networking & Matching</h4>
          
          <div class="form-row">
            <label for="profileLookingFor">Looking For</label>
            <div class="checkbox-group" id="profileLookingFor">
              <label class="checkbox-item">
                <input type="checkbox" value="study-partners"> Study Partners
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="project-collaborators"> Project Collaborators
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="research-partners"> Research Partners
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="internship-referrals"> Internship Referrals
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="mentorship"> Mentorship
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="friends"> Friends
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="networking"> Professional Networking
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="startup-cofounders"> Startup Co-founders
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="hackathon-teammates"> Hackathon Teammates
              </label>
            </div>
          </div>

          <div class="form-row">
            <label for="profileSkills">Skills You Have</label>
            <input type="text" id="profileSkills" placeholder="JavaScript, Python, React, Design, etc." maxlength="200">
            <small>Separate with commas</small>
          </div>

          <div class="form-row">
            <label for="profileLearningGoals">Want to Learn</label>
            <input type="text" id="profileLearningGoals" placeholder="Machine Learning, iOS Development, etc." maxlength="200">
            <small>What skills do you want to develop?</small>
          </div>

          <div class="form-row">
            <label for="profileAvailability">Availability</label>
            <select id="profileAvailability">
              <option value="">Select availability</option>
              <option value="very-available">Very Available</option>
              <option value="moderately-available">Moderately Available</option>
              <option value="limited-availability">Limited Availability</option>
              <option value="busy">Currently Busy</option>
            </select>
          </div>
        </div>

        <!-- Contact & Social -->
        <div class="form-section">
          <h4>Contact & Social</h4>
          
          <div class="form-row">
            <label for="profileLinkedin">LinkedIn Profile</label>
            <input type="url" id="profileLinkedin" placeholder="https://linkedin.com/in/yourname">
          </div>

          <div class="form-row">
            <label>Preferred Contact Methods</label>
            <div class="checkbox-group" id="profileContactPreferences">
              <label class="checkbox-item">
                <input type="checkbox" value="email"> Email
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="linkedin"> LinkedIn
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="discord"> Discord
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="instagram"> Instagram
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="in-person"> In Person
              </label>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="profile-actions">
          <button class="save-profile-btn" id="saveProfileBtn" onclick="saveProfile()">Save Profile</button>
        </div>
      </div>
    </section>

    <!-- Saved Clubs Card -->
    <section class="saved-clubs-card">
      <h2>Saved Clubs</h2>
      <div class="saved-clubs-grid" id="savedClubsGrid">
        <div class="empty-state">
          <div class="empty-state-icon">🔖</div>
          <div class="empty-state-text">No saved clubs yet</div>
          <div class="empty-state-subtext">Explore tech clubs and bookmark your favorites!</div>
        </div>
      </div>
    </section>

    <!-- Upcoming Events Card -->
    <section class="upcoming-events-card">
      <h2>My Upcoming Events</h2>
      <div class="events-list" id="eventsList">
        <div class="empty-state">
          <div class="empty-state-icon">📅</div>
          <div class="empty-state-text">No upcoming events</div>
          <div class="empty-state-subtext">Check back later for new tech events!</div>
        </div>
      </div>
    </section>

    <!-- Test Results Card -->
    <section class="test-results-card">
  <h2>Recent Test Results</h2>
  <div class="test-results-list" id="testResultsList">
    <div class="empty-state">
      <div class="empty-state-icon">🧪</div>
      <div class="empty-state-text">No test results yet</div>
      <div class="empty-state-subtext">
        Take a niche quiz to discover your ideal career path!
        <br><br>
        <small style="color: #94a3b8; font-style: italic;">
          Click on any result to view detailed analysis
        </small>
      </div>
    </div>
  </div>
</section>

    <!-- Potential Matches Card -->
    <section class="potential-matches-card">
      <h2>Potential Matches</h2>
      <div class="matches-list" id="matchesList">
        <div class="empty-state">
          <div class="empty-state-icon">🤝</div>
          <div class="empty-state-text">Complete your profile to find matches</div>
          <div class="empty-state-subtext">Add your interests and goals to connect with similar students!</div>
        </div>
      </div>
      <button class="view-all-matches-btn" onclick="showMatchingModal()" style="display: none;">View All Matches</button>
    </section>

     <section class="connections-card">
      <h2>🤝 Connection Requests</h2>
      <div id="connectionsList" class="connections-list">
        <div class="empty-state">
          <div class="empty-state-icon">📬</div>
          <div class="empty-state-text">No connection requests yet</div>
          <div class="empty-state-subtext">When someone wants to connect, you'll see it here!</div>
        </div>
      </div>
    </section>

  </main>

  <!-- Matching Modal -->
  <div class="modal-overlay" id="matchingModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Find Your Perfect Study/Project Partners</h3>
        <button class="modal-close" onclick="closeMatchingModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="match-filters">
          <select id="matchFilterLookingFor">
            <option value="">What are they looking for?</option>
            <option value="study-partners">Study Partners</option>
            <option value="project-collaborators">Project Collaborators</option>
            <option value="research-partners">Research Partners</option>
            <option value="friends">Friends</option>
          </select>
          <select id="matchFilterMajor">
            <option value="">Any Major</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Engineering">Engineering</option>
            <option value="Data Science">Data Science</option>
          </select>
          <select id="matchFilterYear">
            <option value="">Any Year</option>
            <option value="freshman">Freshman</option>
            <option value="sophomore">Sophomore</option>
            <option value="junior">Junior</option>
            <option value="senior">Senior</option>
            <option value="graduate">Graduate</option>
          </select>
          <button onclick="findMatches()">Find Matches</button>
        </div>
        <div class="matches-results" id="matchesResults">
          <!-- Matches will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading your dashboard...</div>
  </div>

  <script>
    // Global functions for HTML handlers
    function logoutUser() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = '/logout';
      }
    }

    function goToDashboard() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showMatchingModal() {
      document.getElementById('matchingModal').style.display = 'flex';
    }

    function closeMatchingModal() {
      document.getElementById('matchingModal').style.display = 'none';
    }

    async function findMatches() {
      const lookingFor = document.getElementById('matchFilterLookingFor').value;
      const major = document.getElementById('matchFilterMajor').value;
      const year = document.getElementById('matchFilterYear').value;

      try {
        const params = new URLSearchParams();
        if (lookingFor) params.append('lookingFor', lookingFor);
        if (major) params.append('major', major);
        if (year) params.append('year', year);

        const response = await fetch(`/api/user/matches?${params}`);
        const data = await response.json();

        displayMatches(data.matches);
      } catch (error) {
        console.error('Error finding matches:', error);
      }
    }

    function displayMatches(matches) {
      const resultsContainer = document.getElementById('matchesResults');
      
      if (matches.length === 0) {
        resultsContainer.innerHTML = '<p>No matches found. Try adjusting your filters!</p>';
        return;
      }

      resultsContainer.innerHTML = matches.map(match => `
        <div class="match-card">
          <div class="match-avatar">
            ${match.profilePictureUrl ? 
              `<img src="${match.profilePictureUrl}" alt="${match.displayName}">` :
              `<span>${match.displayName.split(' ').map(n => n[0]).join('').toUpperCase()}</span>`
            }
          </div>
          <div class="match-info">
            <h4>${match.displayName}</h4>
            <p class="match-details">${match.year} • ${match.major}</p>
            <p class="match-bio">${match.bio}</p>
            <div class="match-tags">
              ${(match.skills || []).slice(0, 3).map(skill => `<span class="tag">${skill}</span>`).join('')}
            </div>
            <p class="match-score">Match Score: ${match.matchScore}%</p>
          </div>
        </div>
      `).join('');
    }

    // Make functions global
    window.logoutUser = logoutUser;
    window.goToDashboard = goToDashboard;
    window.showMatchingModal = showMatchingModal;
    window.closeMatchingModal = closeMatchingModal;
    window.findMatches = findMatches;
  </script>


  <script>
  // Include the enhanced-results.css styles for modal content
  function loadModalResultsStyles() {
    // Check if styles are already loaded
    if (document.getElementById('modal-results-styles')) return;

    const link = document.createElement('link');
    link.id = 'modal-results-styles';
    link.rel = 'stylesheet';
    link.href = '/styles/enhanced-results.css';
    document.head.appendChild(link);
    
    console.log('📄 Enhanced results styles loaded for modal');
  }

  // Load styles when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    loadModalResultsStyles();
  });

  // Enhanced Test Result Item Creation with Modal Integration
  function createTestResultItem(result) {
    const resultItem = document.createElement('div');
    resultItem.className = 'test-result-item enhanced-clickable';

    const testDate = new Date(result.createdAt || result.date || Date.now());
    const formattedDate = testDate.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });

    let testName = 'Career Assessment';
    let percentage = 75;
    let confidenceLevel = 'Medium';

    if (result.topMatch) {
      testName = result.topMatch.careerName || 'Career Assessment';
      percentage = Math.round(result.topMatch.percentage || 75);
      
      // Determine confidence based on percentage
      if (percentage >= 80) confidenceLevel = 'High';
      else if (percentage >= 60) confidenceLevel = 'Medium';
      else confidenceLevel = 'Low';
    }

    // Enhanced result item with better visual hierarchy
    resultItem.innerHTML = `
      <div class="test-info">
        <div class="test-name-row">
          <div class="test-name">${testName}</div>
          <div class="test-confidence ${confidenceLevel.toLowerCase()}-confidence">
            ${confidenceLevel} Confidence
          </div>
        </div>
        <div class="test-meta">
          <span class="test-date">${formattedDate}</span>
          ${result.quizLevel ? `<span class="test-level">${result.quizLevel} level</span>` : ''}
        </div>
      </div>
      <div class="test-score-container">
        <div class="test-score">${percentage}%</div>
        <div class="view-indicator">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </div>
      </div>
    `;

    // Add click handler to open results modal
    resultItem.addEventListener('click', () => {
      const resultId = result.id || result._id || `sample-result-${Date.now()}`;
      console.log('🎯 Opening results modal for:', testName, resultId);
      
      // Add loading state
      resultItem.classList.add('opening-modal');
      
      // Open modal after brief delay for UX
      setTimeout(() => {
        openResultsModal(resultId);
        resultItem.classList.remove('opening-modal');
      }, 150);
    });

    // Enhanced hover effects with better performance
    let hoverTimeout;
    resultItem.addEventListener('mouseenter', () => {
      clearTimeout(hoverTimeout);
      resultItem.style.transform = 'translateX(8px)';
      resultItem.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(99, 102, 241, 0.04))';
      resultItem.style.borderColor = 'rgba(59, 130, 246, 0.3)';
    });

    resultItem.addEventListener('mouseleave', () => {
      hoverTimeout = setTimeout(() => {
        resultItem.style.transform = 'translateX(0)';
        resultItem.style.background = 'rgba(255, 255, 255, 0.9)';
        resultItem.style.borderColor = 'transparent';
      }, 50);
    });

    // Keyboard accessibility
    resultItem.setAttribute('tabindex', '0');
    resultItem.setAttribute('role', 'button');
    resultItem.setAttribute('aria-label', `View detailed results for ${testName} (${percentage}% match)`);
    
    resultItem.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        resultItem.click();
      }
    });

    return resultItem;
  }

  // Update the test results display function
  function updateTestResultsDisplay() {
    const testResultsList = document.getElementById('testResultsList');
    if (!testResultsList) return;

    if (!dashboardState.testResults || dashboardState.testResults.length === 0) {
      testResultsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">🧪</div>
          <div class="empty-state-text">No test results yet</div>
          <div class="empty-state-subtext">
            Take a <a href="/enhanced-quiz" style="color: #3b82f6; text-decoration: none; font-weight: 500;">career assessment quiz</a> to discover your ideal career path!
            <br><br>
            <small style="color: #94a3b8; font-style: italic;">
              Results will appear here and can be clicked to view detailed analysis
            </small>
          </div>
        </div>
      `;
      return;
    }

    testResultsList.innerHTML = '';
    
    // Add a header for better UX when there are results
    if (dashboardState.testResults.length > 0) {
      const headerDiv = document.createElement('div');
      headerDiv.className = 'results-header';
      headerDiv.innerHTML = `
        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
          Click any result to view detailed career analysis
        </p>
      `;
      testResultsList.appendChild(headerDiv);
    }

    // Create enhanced result items
    dashboardState.testResults.forEach((result, index) => {
      const resultItem = createTestResultItem(result);
      
      // Add staggered animation
      resultItem.style.opacity = '0';
      resultItem.style.transform = 'translateY(20px)';
      
      setTimeout(() => {
        resultItem.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        resultItem.style.opacity = '1';
        resultItem.style.transform = 'translateY(0)';
      }, index * 100);
      
      testResultsList.appendChild(resultItem);
    });

    console.log(`✅ Updated test results display with ${dashboardState.testResults.length} clickable results`);
  }

  // Add CSS for enhanced test result styling
  const enhancedTestResultStyles = `
    <style id="enhanced-test-results-styles">
      .test-result-item.enhanced-clickable {
        border: 2px solid transparent;
        position: relative;
        cursor: pointer;
        user-select: none;
      }

      .test-result-item.opening-modal {
        transform: translateX(3px) scale(0.98) !important;
        opacity: 0.8;
      }

      .test-name-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.25rem;
      }

      .test-confidence {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .high-confidence {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        color: #15803d;
      }

      .medium-confidence {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #d97706;
      }

      .low-confidence {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #dc2626;
      }

      .test-meta {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .test-level {
        font-size: 0.75rem;
        color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
      }

      .test-score-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .view-indicator {
        color: #3b82f6;
        opacity: 0;
        transform: translateX(-5px);
        transition: all 0.3s ease;
      }

      .test-result-item:hover .view-indicator {
        opacity: 1;
        transform: translateX(0);
      }

      .results-header {
        border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
      }

      /* Loading animation for when opening modal */
      @keyframes pulse-blue {
        0%, 100% { 
          background: rgba(59, 130, 246, 0.05);
        }
        50% { 
          background: rgba(59, 130, 246, 0.15);
        }
      }

      .test-result-item.opening-modal {
        animation: pulse-blue 0.8s ease-in-out infinite;
      }

      /* Improved focus states for accessibility */
      .test-result-item:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
        transform: translateX(5px);
      }

      /* Better responsiveness */
      @media (max-width: 768px) {
        .test-name-row {
          flex-direction: column;
          gap: 0.25rem;
        }

        .test-confidence {
          align-self: flex-start;
        }

        .test-meta {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.25rem;
        }
      }
    </style>
  `;

  // Inject enhanced styles
  document.head.insertAdjacentHTML('beforeend', enhancedTestResultStyles);

  console.log('✅ Enhanced test results modal integration loaded');
</script>
</body>

</html>