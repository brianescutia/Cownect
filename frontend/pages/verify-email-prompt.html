<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verify Your Email | Cownect</title>
    <link rel="stylesheet" href="../styles/login.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rethink+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/emailVerification.css">
</head>

<body class="background">
    <!-- Header Logo -->
    <div class="header-logo">
        <img src="../assets/COW.png" alt="Cownect Logo featuring a cow">
        <h1>Cownect</h1>
    </div>

    <main class="main-container">
        <div class="verification-container">
            <div class="verification-icon">üìß</div>
            <h2 class="verification-title">Check Your Email!</h2>

            <p class="verification-text">
                We've sent a verification link to:
            </p>

            <div class="email-display" id="userEmail">
                <!-- Email will be populated by JavaScript -->
            </div>

            <p class="verification-text">
                Click the verification link in your email to activate your account and start discovering UC Davis tech
                clubs!
            </p>

            <!-- Alert messages -->
            <div id="alertContainer"></div>

            <div class="resend-section">
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                    Didn't receive the email? Check your spam folder or:
                </p>

                <button id="resendBtn" class="resend-btn">
                    Resend Verification Email
                </button>

                <div id="resendTimer" style="margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280;"></div>
            </div>

            <div class="action-links">
                <a href="/login" class="back-link">‚Üê Back to Login</a>
                <a href="/signup" class="back-link">‚Üê Try Different Email</a>
            </div>
        </div>
    </main>

    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const status = urlParams.get('status');
        const error = urlParams.get('error');

        // Display email
        if (email) {
            document.getElementById('userEmail').textContent = decodeURIComponent(email);
        } else {
            document.getElementById('userEmail').textContent = 'your UC Davis email';
        }

        // Show appropriate status messages
        if (status) {
            showStatusMessage(status);
        }

        if (error) {
            showAlert(getErrorMessage(error), 'error');
        }

        function showStatusMessage(status) {
            let message = '';
            let type = 'success';

            switch (status) {
                case 'sent':
                    message = '‚úÖ Account created! Verification email sent successfully.';
                    break;
                case 'resent':
                    message = '‚úÖ We found your account! New verification email sent.';
                    break;
                case 'email_error':
                    message = '‚ö†Ô∏è Account created, but there was an issue sending the email. You can request a new one below.';
                    type = 'warning';
                    break;
                default:
                    return;
            }

            showAlert(message, type);
        }

        // Resend functionality
        let resendCooldown = 0;
        const resendBtn = document.getElementById('resendBtn');
        const resendTimer = document.getElementById('resendTimer');

        resendBtn.addEventListener('click', async () => {
            if (resendCooldown > 0) return;

            try {
                resendBtn.textContent = 'Sending...';
                resendBtn.disabled = true;

                const response = await fetch('/api/resend-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email || '' })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('‚úÖ Verification email sent! Check your inbox.', 'success');
                    startResendCooldown();
                } else {
                    showAlert(`‚ùå ${data.error || 'Failed to send email'}`, 'error');
                    resendBtn.textContent = 'Resend Verification Email';
                    resendBtn.disabled = false;
                }

            } catch (error) {
                console.error('Resend error:', error);
                showAlert('‚ùå Network error. Please try again.', 'error');
                resendBtn.textContent = 'Resend Verification Email';
                resendBtn.disabled = false;
            }
        });

        function startResendCooldown() {
            resendCooldown = 60; // 60 seconds
            updateResendTimer();

            const interval = setInterval(() => {
                resendCooldown--;
                updateResendTimer();

                if (resendCooldown <= 0) {
                    clearInterval(interval);
                    resendBtn.textContent = 'Resend Verification Email';
                    resendBtn.disabled = false;
                    resendTimer.textContent = '';
                }
            }, 1000);
        }

        function updateResendTimer() {
            if (resendCooldown > 0) {
                resendBtn.textContent = `Wait ${resendCooldown}s`;
                resendTimer.textContent = `You can request another email in ${resendCooldown} seconds`;
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            // Clear existing alerts
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);

            // Auto-hide success messages after 7 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 7000);
            }
        }

        function getErrorMessage(error) {
            const messages = {
                'missing_token': 'Verification link is missing. Please try signing up again.',
                'invalid_token': 'Verification link is invalid or expired. Please request a new one.',
                'server': 'Server error occurred. Please try again later.',
                'not_verified': 'Your account is not yet verified. Please check your email for the verification link.'
            };
            return messages[error] || 'An unknown error occurred.';
        }

        // Auto-focus on resend button for accessibility
        if (!error) {
            setTimeout(() => resendBtn.focus(), 100);
        }
    </script>
</body>

</html>